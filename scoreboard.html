<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Scoreboard</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <style>
    body {
      margin: 0;
      background: radial-gradient(circle at top, #201b7c 0%, #13124d 45%, #070a21 100%);
      background-size: 220% 220%;
      animation: aurora 18s ease-in-out infinite alternate;
      min-height: 100vh;
      color: #e2e8f0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    main {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 16px;
    }
    .wrapper {
      width: 100%;
      max-width: 1100px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 32px;
      padding: 40px;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 40px 120px rgba(2,6,23,0.85);
    }
    .badge-soft {
      background: rgba(59,130,246,0.12);
      border: 1px solid rgba(59,130,246,0.35);
      color: #bfdbfe;
      border-radius: 999px;
      padding: 6px 18px;
      font-size: 0.85rem;
    }
    .podium-card {
      border-radius: 18px;
      padding: 20px 16px;
      background: rgba(30, 41, 59, 0.85);
      border: 1px solid rgba(148,163,184,0.2);
      text-align: center;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04), 0 18px 45px rgba(0,0,0,0.5);
    }
    .podium-card.gold { border-color: rgba(250,204,21,0.6); color: #facc15; animation: glowGold 3s ease-in-out infinite; }
    .podium-card.silver { border-color: rgba(229,231,235,0.5); color: #f3f4f6; animation: glowSilver 3s ease-in-out infinite; }
    .podium-card.bronze { border-color: rgba(249,115,22,0.5); color: #fb923c; animation: glowBronze 3s ease-in-out infinite; }
    .table-divider thead th {
      border-bottom: none;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.6px;
      color: #cbd5f5;
      background: rgba(15, 23, 42, 0.7);
    }
    .table-divider tbody td {
      border-color: rgba(148,163,184,0.2) !important;
      background: rgba(15,23,42,0.45);
      color: #f1f5f9;
    }
    .table-divider th:not(:last-child),
    .table-divider td:not(:last-child) {
      border-right: 2px solid rgba(148,163,184,0.4) !important;
    }
    .table-divider tbody tr:not(:last-child) td {
      border-bottom: 1px solid rgba(148,163,184,0.25) !important;
    }
    .table-divider tbody td {
      font-weight: 600;
      letter-spacing: 0.4px;
    }
    .gold { color: #facc15; font-weight: 700; }
    .silver { color: #e2e8f0; font-weight: 600; }
    .bronze { color: #fb923c; font-weight: 600; }
    .fade-up {
      opacity: 0;
      transform: translateY(30px);
      animation: fadeUp 0.9s ease forwards;
    }
    .fade-up.delay-1 { animation-delay: 0.2s; }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes aurora {
      0% { background-position: 0% 0%; }
      50% { background-position: 100% 60%; }
      100% { background-position: 0% 100%; }
    }
    @keyframes rowFade {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes glowGold {
      0%,100% { box-shadow: 0 18px 40px rgba(250,204,21,0.25), inset 0 0 0 rgba(250,204,21,0.4); }
      50% { box-shadow: 0 25px 55px rgba(250,204,21,0.45), inset 0 0 25px rgba(250,204,21,0.4); }
    }
    @keyframes glowSilver {
      0%,100% { box-shadow: 0 18px 40px rgba(148,163,184,0.25), inset 0 0 0 rgba(148,163,184,0.3); }
      50% { box-shadow: 0 25px 55px rgba(148,163,184,0.4), inset 0 0 25px rgba(148,163,184,0.35); }
    }
    @keyframes glowBronze {
      0%,100% { box-shadow: 0 18px 40px rgba(249,115,22,0.25), inset 0 0 0 rgba(249,115,22,0.35); }
      50% { box-shadow: 0 25px 55px rgba(249,115,22,0.45), inset 0 0 25px rgba(249,115,22,0.4); }
    }
  </style>
</head>
<body>
  <main>
    <div class="wrapper fade-up">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
        <div>
          <p class="text-uppercase text-warning small fw-semibold mb-1">Live scoreboard</p>
          <h1 class="h3 fw-bold text-white mb-1">Event Rankings</h1>
          <p class="badge-soft mb-0" id="info">Loading...</p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-light" onclick="location.href='player-home.html'">Player Home</button>
        </div>
      </div>

      <div class="row g-3 mb-4" id="podium"></div>

      <div class="table-responsive rounded-4 border border-opacity-25 border-light">
        <table class="table table-dark table-hover table-divider align-middle mb-0">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Player</th>
              <th>Score</th>
              <th>Wrong</th>
              <th>Time (sec)</th>
              <th>Timestamp</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <!-- filled by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </main>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script>

    const infoEl = document.getElementById("info");
    const tableBody = document.getElementById("table-body");
    const podiumEl = document.getElementById("podium");

    function getScoreStats(player) {
      const score = typeof player.score === "number" ? player.score : parseFloat(player.score) || 0;
      const wrong = typeof player.wrongCount === "number" ? player.wrongCount : parseFloat(player.wrongCount) || 0;
      const time = typeof player.time === "number" ? player.time : parseFloat(player.time) || Number.MAX_VALUE;
      return { score, wrong, time };
    }

    function sortPlayers(players) {
      return players.slice().sort((a, b) => {
        const aStats = getScoreStats(a);
        const bStats = getScoreStats(b);

        if (aStats.score !== bStats.score) return bStats.score - aStats.score;
        if (aStats.wrong !== bStats.wrong) return aStats.wrong - bStats.wrong;
        if (aStats.time !== bStats.time) return aStats.time - bStats.time;

        const timeStampA = new Date(a.timestamp || 0).getTime();
        const timeStampB = new Date(b.timestamp || 0).getTime();
        return timeStampA - timeStampB;
      });
    }

    function renderPodium(players) {
      podiumEl.innerHTML = "";
      if (!players.length) {
        podiumEl.innerHTML = "<div class='col-12'><p class='text-center text-white-50 mb-0'>No scores yet.</p></div>";
        return;
      }
      const ordered = sortPlayers(players).slice(0, 3);
      const labels = ["1st", "2nd", "3rd"];
      ordered.forEach((player, idx) => {
        const role = idx === 0 ? "gold" : idx === 1 ? "silver" : "bronze";
        const col = document.createElement("div");
        col.className = "col-12 col-md-4";
        const div = document.createElement("div");
        div.className = `podium-card ${role}`;
        const playerName = player.name || "Unknown";
        const { score, wrong, time } = getScoreStats(player);
        div.innerHTML = `
          <p class="podium-rank">${labels[idx]}</p>
          <p class="podium-name">${playerName}</p>
          <p class="podium-time">Score ${score} · Wrong ${wrong} · ${Number.isFinite(time) ? time.toFixed(2) : "-"}s</p>
        `;
        col.appendChild(div);
        podiumEl.appendChild(col);
      });
    }

    function renderScores(players) {
      tableBody.innerHTML = "";
      podiumEl.innerHTML = "";
      
      if (!players.length) {
        infoEl.textContent = "No players yet.";
        tableBody.innerHTML = "<tr><td class='text-center text-white-50 py-4' colspan='6'>No data available</td></tr>";
        renderPodium([]);
        return;
      }

      const ordered = sortPlayers(players);
      infoEl.textContent = "Total players: " + ordered.length + " (Ranked by Score → Wrong → Time)";
      renderPodium(ordered);

      ordered.forEach((player, index) => {
        const tr = document.createElement("tr");
        tr.style.animationDelay = `${index * 0.03}s`;
        tr.style.opacity = "0";
        tr.style.transform = "translateY(8px)";
        tr.style.animation = "rowFade 0.4s ease forwards";

        const rank = index + 1;
        let cls = "";
        if (rank === 1) cls = "gold";
        else if (rank === 2) cls = "silver";
        else if (rank === 3) cls = "bronze";

        const playerName = player.name || "Unknown";
        const { score, wrong, time } = getScoreStats(player);
        const formattedTime = Number.isFinite(time) ? time.toFixed(2) : "-";
        const playerTimestamp = player.timestamp ? new Date(player.timestamp).toLocaleString() : "";

        tr.innerHTML = `
          <td class="${cls}">${rank}</td>
          <td class="${cls}">${playerName}</td>
          <td class="${cls}">${score}</td>
          <td class="${cls}">${wrong}</td>
          <td class="${cls}">${formattedTime}</td>
          <td>${playerTimestamp}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    function loadScores() {
      infoEl.textContent = "Loading scores...";
      tableBody.innerHTML = "";
      podiumEl.innerHTML = "";
      
      try {
        // Use real-time listener for live updates
        db.collection("players").onSnapshot((snap) => {
          const players = [];
          snap.forEach(doc => {
            const data = doc.data();
            players.push({ 
              id: doc.id, 
              name: data.name || "Unknown",
              score: data.score ?? data.correctCount ?? 0,
              wrongCount: data.wrongCount ?? 0,
              time: data.time ?? data.totalTime ?? null,
              timestamp: data.timestamp || ""
            });
          });
          
          console.log("Loaded players:", players);
          renderScores(players);
        }, (err) => {
          console.error("Error loading scores:", err);
          infoEl.textContent = "Error loading data: " + (err.message || "Unknown error");
          tableBody.innerHTML = "<tr><td class='empty' colspan='6'>Unable to load scores. Check Firebase config.</td></tr>";
          renderPodium([]);
        });
      } catch (err) {
        console.error("Error setting up listener:", err);
        infoEl.textContent = "Error: " + (err.message || "Unknown error");
        tableBody.innerHTML = "<tr><td class='empty' colspan='6'>Unable to connect. Check Firebase config.</td></tr>";
        renderPodium([]);
      }
    }

    if (document.fullscreenElement) {
      document.exitFullscreen().catch(() => {});
    }

    loadScores();
  </script>
</body>
</html>

